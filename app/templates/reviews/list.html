{% extends "base.html" %}
{% block title %}評價列表 - StudentTrade{% endblock %}

{% block content %}
<section class="py-10">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 space-y-6">
        <div class="bg-white rounded-xl shadow-card p-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-3">
                <div class="w-16 h-16 rounded-full bg-primaryLight flex items-center justify-center text-xl">
                    {{ user.username[0]|upper if user.username else '?' }}
                </div>
                <div>
                    <p class="text-lg font-semibold text-secondaryDark">{{ user.username }}的評價</p>
                    <div class="flex items-center gap-2 text-sm">
                        <div class="flex items-center gap-1">
                            {% for i in range(1, 6) %}
                                {% set active = i <= stats.average_rating|round(0) %}
                                <svg class="w-4 h-4 {{ 'text-yellow-400' if active else 'text-secondary/40' }}" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.975a1 1 0 00.95.69h4.184c.969 0 1.371 1.24.588 1.81l-3.389 2.463a1 1 0 00-.364 1.118l1.286 3.974c.3.922-.755 1.688-1.538 1.118l-3.389-2.463a1 1 0 00-1.175 0l-3.389 2.463c-.783.57-1.838-.196-1.538-1.118l1.286-3.974a1 1 0 00-.364-1.118L2.01 9.402c-.783-.57-.38-1.81.588-1.81h4.184a1 1 0 00.95-.69l1.286-3.975z"></path>
                                </svg>
                            {% endfor %}
                        </div>
                        {% if stats.total_reviews > 0 %}
                        <span class="text-secondary">評分 {{ stats.average_rating }} / 5.0 ({{ stats.total_reviews }} 則評價)</span>
                        {% else %}
                        <span class="text-secondary">尚無評價</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <a class="px-4 py-2 rounded-lg bg-primary text-white shadow-md hover:bg-primaryHover"
               href="{{ url_for('products.seller', user_id=user.id) }}">查看賣家商品</a>
        </div>

        <div class="space-y-4">
            {% if reviews %}
                {% for review in reviews %}
                    <div class="bg-white rounded-xl shadow-card p-5 space-y-2">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <div class="flex items-center gap-1">
                                    {% for i in range(1, 6) %}
                                        {% set active = i <= review.rating %}
                                        <svg class="w-4 h-4 {{ 'text-yellow-400' if active else 'text-secondary/40' }}" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.975a1 1 0 00.95.69h4.184c.969 0 1.371 1.24.588 1.81l-3.389 2.463a1 1 0 00-.364 1.118l1.286 3.974c.3.922-.755 1.688-1.538 1.118l-3.389-2.463a1 1 0 00-1.175 0l-3.389 2.463c-.783.57-1.838-.196-1.538-1.118l1.286-3.974a1 1 0 00-.364-1.118L2.01 9.402c-.783-.57-.38-1.81.588-1.81h4.184a1 1 0 00.95-.69l1.286-3.975z"></path>
                                        </svg>
                                    {% endfor %}
                                </div>
                                <span class="text-sm text-secondary">{{ review.rating }} / 5</span>
                            </div>
                            <span class="text-sm text-secondary">{{ review.created_at.strftime('%Y-%m-%d') }}</span>
                        </div>
                        <p class="text-secondaryDark font-medium">{{ review.reviewer.username if review.reviewer else '匿名' }}</p>
                        <p class="text-sm text-secondary">
                            交易：{{ review.transaction.product.title if review.transaction and review.transaction.product else '已刪除的商品' }}
                        </p>
                        {% if review.comment %}
                        <p class="text-secondary leading-relaxed">{{ review.comment }}</p>
                        {% else %}
                        <p class="text-secondary leading-relaxed">（未留下評語）</p>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="bg-white rounded-xl shadow-card p-10 text-center text-secondary">
                    尚無評價
                </div>
            {% endif %}
        </div>

        {% if pagination.pages > 1 %}
        <div class="flex justify-center items-center gap-2 pt-2">
            {% if pagination.has_prev %}
            <a href="{{ url_for('reviews.user_reviews', user_id=user.id, page=pagination.prev_num) }}"
                class="px-3 py-2 rounded border border-secondaryLight hover:bg-primaryLight">
                &larr;
            </a>
            {% else %}
            <span class="px-3 py-2 rounded border border-secondaryLight text-gray-300 cursor-not-allowed">&larr;</span>
            {% endif %}

            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
            {% if page_num %}
            {% if page_num == pagination.page %}
            <span class="px-3 py-2 rounded bg-primary text-white shadow">{{ page_num }}</span>
            {% else %}
            <a href="{{ url_for('reviews.user_reviews', user_id=user.id, page=page_num) }}"
                class="px-3 py-2 rounded border border-secondaryLight hover:bg-primaryLight">
                {{ page_num }}
            </a>
            {% endif %}
            {% else %}
            <span class="text-secondary">...</span>
            {% endif %}
            {% endfor %}

            {% if pagination.has_next %}
            <a href="{{ url_for('reviews.user_reviews', user_id=user.id, page=pagination.next_num) }}"
                class="px-3 py-2 rounded border border-secondaryLight hover:bg-primaryLight">
                &rarr;
            </a>
            {% else %}
            <span class="px-3 py-2 rounded border border-secondaryLight text-gray-300 cursor-not-allowed">&rarr;</span>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}
