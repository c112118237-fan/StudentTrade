<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}StudentTrade{% endblock %}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
        integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
        crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        primaryHover: '#1D4ED8',
                        primaryLight: '#DBEAFE',
                        secondary: '#64748B',
                        secondaryDark: '#1E293B',
                        secondaryLight: '#F1F5F9',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        accent: '#EC4899'
                    },
                    fontFamily: {
                        sans: ['Noto Sans TC', 'Inter', 'system-ui', 'sans-serif']
                    },
                    boxShadow: {
                        card: '0 4px 6px rgba(0,0,0,0.1)',
                        cardHover: '0 10px 15px rgba(0,0,0,0.1)',
                        dropdown: '0 25px 50px rgba(0,0,0,0.25)'
                    }
                }
            }
        };
    </script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">
    {% block head %}{% endblock %}
</head>

<body class="bg-gray-50 text-secondaryDark font-sans antialiased">
    <a href="#main"
        class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-primary text-white px-3 py-2 rounded-md">跳到主要內容</a>
    <div class="min-h-screen flex flex-col">
        {% include 'components/navbar.html' %}
        <main id="main" class="flex-1">
            {% block content %}{% endblock %}
        </main>
        {% include 'components/footer.html' %}
    </div>

    <!-- Toast 通知系統 -->
    {% include 'components/toast.html' %}

    <!-- Global WebSocket for real-time notifications -->
    {% if current_user.is_authenticated %}
    <script>
        (function () {
            // Initialize global Socket.IO connection for notifications
            const socket = io();
            const currentUserId = {{ current_user.id | tojson
        }};

        // Connect and join personal room
        socket.on('connect', function () {
            console.log('Global WebSocket connected');
            socket.emit('join_user_room');
        });

        // Handle unread count updates
        socket.on('update_unread_count', function (data) {
            console.log('Global unread count update:', data.count);

            // Update badge elements by ID
            const desktopBadge = document.getElementById('unread-badge-desktop');
            const mobileBadge = document.getElementById('unread-badge-mobile');

            [desktopBadge, mobileBadge].forEach(badge => {
                if (badge) {
                    if (data.count > 0) {
                        badge.textContent = data.count <= 9 ? data.count : '9+';
                        badge.classList.remove('hidden');
                    } else {
                        badge.classList.add('hidden');
                    }
                }
            });
        });

        // Handle new message notifications (when user is not in chat page)
        socket.on('new_message_notification', function (data) {
            console.log('New message notification:', data);

            // Show toast notification
            if (typeof Toast !== 'undefined' && Toast.info) {
                const preview = data.content.substring(0, 50);
                const message = `來自 ${data.sender_username} 的新訊息: ${preview}${data.content.length > 50 ? '...' : ''}`;
                Toast.info(message, 5000);
            }

            // Play notification sound (optional)
            // const audio = new Audio('/static/sounds/notification.mp3');
            // audio.play();
        });
        }) ();
    </script>
    {% endif %}

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% block scripts %}{% endblock %}
</body>

</html>