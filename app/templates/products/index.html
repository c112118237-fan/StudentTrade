{% extends "base.html" %}
{% block title %}商品列表 - StudentTrade{% endblock %}

{% block content %}
<section class="bg-white/70 border-b border-secondaryLight">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 space-y-6">
        <!-- Search Section -->
        <div class="space-y-3">
            <h1 class="text-2xl font-semibold text-secondaryDark">搜尋商品</h1>
            <p class="text-secondary text-sm">輸入關鍵字或分類，快速找到你想要的物品</p>
            <form method="get" action="{{ url_for('products.index') }}" class="w-full md:w-3/4 lg:w-1/2 flex gap-2">
                <input name="search" type="search" placeholder="搜尋商品、分類、品牌..."
                    value="{{ request.args.get('search', '') }}"
                    class="flex-1 px-4 py-3 rounded-lg border border-secondaryLight focus:ring-2 focus:ring-primary/60 focus:border-primary">
                <button type="submit"
                    class="px-6 py-3 bg-primary text-white rounded-lg shadow-md hover:bg-primaryHover whitespace-nowrap">
                    搜尋
                </button>
                <!-- Preserve other filters -->
                {% if request.args.get('category') %}
                <input type="hidden" name="category" value="{{ request.args.get('category') }}">
                {% endif %}
                {% if request.args.get('condition') %}
                <input type="hidden" name="condition" value="{{ request.args.get('condition') }}">
                {% endif %}
                {% if request.args.get('min_price') %}
                <input type="hidden" name="min_price" value="{{ request.args.get('min_price') }}">
                {% endif %}
                {% if request.args.get('max_price') %}
                <input type="hidden" name="max_price" value="{{ request.args.get('max_price') }}">
                {% endif %}
                {% if request.args.get('sort_by') %}
                <input type="hidden" name="sort_by" value="{{ request.args.get('sort_by') }}">
                {% endif %}
                {% if request.args.get('order') %}
                <input type="hidden" name="order" value="{{ request.args.get('order') }}">
                {% endif %}
            </form>
        </div>

        <!-- Category Quick Links -->
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-secondary text-sm font-medium">分類：</span>
            {% for cat in categories %}
            <a href="{{ url_for('products.index', category=cat.id, search=request.args.get('search', ''), condition=request.args.get('condition'), min_price=request.args.get('min_price'), max_price=request.args.get('max_price'), sort_by=request.args.get('sort_by'), order=request.args.get('order')) }}"
                class="px-3 py-2 rounded-full border {{ 'border-primary bg-primary text-white font-medium' if request.args.get('category') == cat.id|string else 'border-secondaryLight text-secondary hover:border-primary hover:text-primary' }}">
                {{ cat.name }}
            </a>
            {% endfor %}
            {% if request.args.get('category') %}
            <a href="{{ url_for('products.index', search=request.args.get('search', ''), condition=request.args.get('condition'), min_price=request.args.get('min_price'), max_price=request.args.get('max_price'), sort_by=request.args.get('sort_by'), order=request.args.get('order')) }}"
                class="px-3 py-2 rounded-full border border-danger text-danger hover:bg-danger hover:text-white">
                清除 ×
            </a>
            {% endif %}
        </div>

        <!-- Condition Filter Tags -->
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-secondary text-sm font-medium">商品狀況：</span>
            {% for cond in ['全新', '近全新', '良好', '普通'] %}
            <a href="{{ url_for('products.index', category=request.args.get('category'), search=request.args.get('search', ''), condition=cond, min_price=request.args.get('min_price'), max_price=request.args.get('max_price'), sort=request.args.get('sort')) }}"
                class="px-3 py-2 rounded-full border {{ 'border-primary bg-primary text-white font-medium' if request.args.get('condition') == cond else 'border-secondaryLight text-secondary hover:border-primary hover:text-primary' }}">
                {{ cond }}
            </a>
            {% endfor %}
            {% if request.args.get('condition') %}
            <a href="{{ url_for('products.index', category=request.args.get('category'), search=request.args.get('search', ''), min_price=request.args.get('min_price'), max_price=request.args.get('max_price'), sort=request.args.get('sort')) }}"
                class="px-3 py-2 rounded-full border border-danger text-danger hover:bg-danger hover:text-white">
                清除 ×
            </a>
            {% endif %}
        </div>

        <!-- Price Range Filter Tags -->
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-secondary text-sm font-medium">價格範圍：</span>
            {% set price_ranges = [
            {'label': '$0-100', 'min': '0', 'max': '100'},
            {'label': '$100-500', 'min': '100', 'max': '500'},
            {'label': '$500-1000', 'min': '500', 'max': '1000'},
            {'label': '$1000-5000', 'min': '1000', 'max': '5000'},
            {'label': '$5000+', 'min': '5000', 'max': ''}
            ] %}
            {% for range in price_ranges %}
            {% set is_active = (request.args.get('min_price', '') == range.min and request.args.get('max_price', '') ==
            range.max) %}
            <a href="{{ url_for('products.index', category=request.args.get('category'), search=request.args.get('search', ''), condition=request.args.get('condition'), min_price=range.min, max_price=range.max if range.max else none, sort=request.args.get('sort')) }}"
                class="px-3 py-2 rounded-full border {{ 'border-primary bg-primary text-white font-medium' if is_active else 'border-secondaryLight text-secondary hover:border-primary hover:text-primary' }}">
                {{ range.label }}
            </a>
            {% endfor %}
            {% if request.args.get('min_price') or request.args.get('max_price') %}
            <a href="{{ url_for('products.index', category=request.args.get('category'), search=request.args.get('search', ''), condition=request.args.get('condition'), sort=request.args.get('sort')) }}"
                class="px-3 py-2 rounded-full border border-danger text-danger hover:bg-danger hover:text-white">
                清除 ×
            </a>
            {% endif %}
        </div>

        <!-- Sorting Filter Tags -->
        <div class="flex flex-wrap gap-2 items-center">
            <span class="text-secondary text-sm font-medium">排序：</span>
            {% set sort_options = [
            {'label': '最新優先', 'value': 'created_at-desc'},
            {'label': '價格：低到高', 'value': 'price-asc'},
            {'label': '價格：高到低', 'value': 'price-desc'}
            ] %}
            {% for option in sort_options %}
            {% set current_sort = request.args.get('sort', 'created_at-desc') %}
            <a href="{{ url_for('products.index', category=request.args.get('category'), search=request.args.get('search', ''), condition=request.args.get('condition'), min_price=request.args.get('min_price'), max_price=request.args.get('max_price'), sort=option.value) }}"
                class="px-3 py-2 rounded-full border {{ 'border-primary bg-primary text-white font-medium' if current_sort == option.value else 'border-secondaryLight text-secondary hover:border-primary hover:text-primary' }}">
                {{ option.label }}
            </a>
            {% endfor %}
        </div>

        <!-- Clear All Filters -->
        {% if request.args.get('category') or request.args.get('condition') or request.args.get('min_price') or
        request.args.get('max_price') or request.args.get('sort') != 'created_at-desc' %}
        <div class="flex justify-end">
            <a href="{{ url_for('products.index', search=request.args.get('search', '')) }}"
                class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border-2 border-danger text-danger hover:bg-danger hover:text-white transition font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
                清除所有篩選
            </a>
        </div>
        {% endif %}
    </div>
</section>

<section class="py-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Product Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {% for product in products %}
            {% include 'components/product_card.html' with context %}
            {% endfor %}
        </div>

        <!-- Pagination -->
        {% if pagination.pages > 1 %}
        <div class="flex justify-center items-center gap-2 pt-8">
            {# 上一頁 #}
            {% if pagination.has_prev %}
            <a href="{{ url_for('products.index', page=pagination.prev_num, search=request.args.get('search'), category=request.args.get('category'), condition=request.args.get('condition'), min_price=request.args.get('min_price'), max_price=request.args.get('max_price'), sort_by=request.args.get('sort_by'), order=request.args.get('order')) }}"
                class="px-3 py-2 rounded border border-secondaryLight hover:bg-primaryLight">
                &larr;
            </a>
            {% else %}
            <span class="px-3 py-2 rounded border border-secondaryLight text-gray-300 cursor-not-allowed">&larr;</span>
            {% endif %}

            {# 頁碼 #}
            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
            {% if page_num %}
            {% if page_num == pagination.page %}
            <span class="px-3 py-2 rounded bg-primary text-white shadow">{{ page_num }}</span>
            {% else %}
            <a href="{{ url_for('products.index', page=page_num, search=request.args.get('search'), category=request.args.get('category'), condition=request.args.get('condition'), min_price=request.args.get('min_price'), max_price=request.args.get('max_price'), sort_by=request.args.get('sort_by'), order=request.args.get('order')) }}"
                class="px-3 py-2 rounded border border-secondaryLight hover:bg-primaryLight">
                {{ page_num }}
            </a>
            {% endif %}
            {% else %}
            <span class="text-secondary">...</span>
            {% endif %}
            {% endfor %}

            {# 下一頁 #}
            {% if pagination.has_next %}
            <a href="{{ url_for('products.index', page=pagination.next_num, search=request.args.get('search'), category=request.args.get('category'), condition=request.args.get('condition'), min_price=request.args.get('min_price'), max_price=request.args.get('max_price'), sort_by=request.args.get('sort_by'), order=request.args.get('order')) }}"
                class="px-3 py-2 rounded border border-secondaryLight hover:bg-primaryLight">
                &rarr;
            </a>
            {% else %}
            <span class="px-3 py-2 rounded border border-secondaryLight text-gray-300 cursor-not-allowed">&rarr;</span>
            {% endif %}
        </div>
        {% endif %}
    </div>
</section>
{% endblock %}